#!/usr/bin/env node
var fs = require('fs');
var path = require('path');
var spawn = require('child_process').spawn;
var exec = require('child_process').exec;
var execFile = require('child_process').execFile;

// Determine base prosp directory.
var home = process.env.HOME;
var prospDir = home + '/prosp';

// Determine subdirectory in prosp (basename of nearest dir containing .git)
var curDir = path.resolve(process.cwd());
var targetDir = '';
while (curDir != '/') {
  // Check to see if the current directory contains a .git directory.
  if (fs.existsSync(curDir + '/.git'))
  {
    targetDir = curDir;
    break;
  }

  // We didn't succeed, grab parent directory.
  curDir = path.dirname(curDir);
}

// Exit with failure.
if (targetDir.length === 0)
{
  console.error("Failed to find git directory.");
  process.exit(1);
}

// Grab basename. This is what we will use as prosp's directory name.
var prospSubDir = path.basename(targetDir);
prospDir += "/" + prospSubDir;

if (fs.existsSync(prospDir) == false)
{
  console.error("Could not find directory '" + prospDir + "'");
  process.exit(1);
}

// Construct the executable to call.
var exeFilename = '';
if (process.argv.length > 2)
{
  // See if the user wants to list all commands (we need some more
  // sophisticated command line processing).
  if (process.argv[2] === '-l')
  {
    // List all possible commands from the target directory.
    // Call each command to obtain their description.
    var files = fs.readdirSync(prospDir);
    for(var i in files) {
      var filePath = prospDir + "/" + files[i];
      // Exclude directories (possibly only check for executable files).
      if (fs.lstatSync(filePath).isDirectory() == false) {
        // Exclude hidden files.
        if (files[i][0] != '.') {
          child = spawn(filePath, ['-h'], { stdio: 'inherit'  });
        }
      }
    }
    process.exit(0);
  }
  else
  {
    process.argv.slice(2).forEach(function (fileName) {
      if (exeFilename.length === 0) {
        exeFilename = fileName;
      }
      else {
        exeFilename += "_" + fileName;
      }
    });
  }
}
else
{
  console.error("At least one parameter required.");
  process.exit(1);
}
var commandName = exeFilename.replace("_", " ");
exeFilename += ".sh";

var fullExePath = prospDir + "/" + exeFilename;

if (fs.existsSync(fullExePath) == false)
{
  console.error("Could not find command '" + commandName + "'");
  console.error("Absolute filename: '" + fullExePath + "'");
  process.exit(1);
}
console.log("Executing: " + fullExePath);

spawn(fullExePath, [], { stdio: 'inherit'  });

// Actual directory of the script (__dirname) and full path to the filename of
// the script (__filename).
//console.log(__dirname);
//console.log(__filename);
